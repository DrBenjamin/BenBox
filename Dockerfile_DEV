FROM mambaorg/micromamba:1.5.8-jammy

ENV DEBIAN_FRONTEND=noninteractive
ENV USERNAME=ben
ENV HOME=/home/$USERNAME
USER root

# Install curl and Node.js (with npm and npx)
RUN apt-get update && \
    apt-get install -y curl ca-certificates gnupg && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Creating user early for better cache
RUN useradd -m -s /bin/bash -d $HOME $USERNAME && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

USER $USERNAME
WORKDIR $HOME/BenBox

# Copy environment_DEV.yml and requirements_MCP.txt before installing dependencies
COPY --chown=ben:ben environment_DEV.yml $HOME/BenBox/environment_DEV.yml
COPY --chown=ben:ben requirements_MCP.txt $HOME/BenBox/requirements_MCP.txt

# Create conda environment and install dependencies
RUN micromamba create -y -n mcp -f environment_DEV.yml && \
    micromamba clean -a -y

ENV MAMBA_DOCKERFILE_ACTIVATE=1
ENV CONDA_DEFAULT_ENV=mcp
ENV PATH="/home/ben/micromamba/envs/mcp/bin:$PATH"

# Copy the rest of the application code
COPY --chown=ben:ben . $HOME/BenBox

USER root
RUN chown -R ben:ben $HOME/BenBox
USER ben

# Exposing the port your MCP dev server will run on
EXPOSE 6274

# Command to run the MCP server
ENTRYPOINT ["micromamba", "run", "-n", "mcp", "mcp", "dev", "src/server.py"]
